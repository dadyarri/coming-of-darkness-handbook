---
import { Icon } from "astro-icon/components";
---

<div class="character-list">
    <div id="character-list-content">
        <div class="character-list__empty">
            <Icon name="game-icons:locked-chest" class="character-list__icon" />
            <p class="character-list__text">Войдите, чтобы посмотреть своих персонажей</p>
        </div>
    </div>
</div>

<script>
    import { supabase } from "../lib/supabase";

    const contentContainer = document.getElementById("character-list-content");

    const updateUI = async (user: any) => {
        if (!contentContainer) return;

        if (!user) {
            contentContainer.innerHTML = `
                <div class="character-list__empty">
                    <svg class="character-list__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <p class="character-list__text">Войдите, чтобы посмотреть своих персонажей</p>
                </div>
            `;
            return;
        }

        try {
            const { data: characters, error } = await supabase
                .from('character_lists')
                .select('*')
                .eq('owner', user.id);

            if (error) throw error;

            if (!characters?.length) {
                contentContainer.innerHTML = `
                    <div class="character-list__empty">
                        <svg class="character-list__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                        <p class="character-list__text">Персонажи не найдены</p>
                    </div>
                `;
                return;
            }

            // Get portrait URLs for all characters
            const charactersWithPortraits = await Promise.all(
                characters.map(async (character) => {
                    if (character.portrait) {
                        const { data } = await supabase.storage
                            .from('cod-portraits')
                            .getPublicUrl(character.portrait);
                        return { ...character, portraitUrl: data.publicUrl };
                    }
                    return character;
                })
            );

            contentContainer.innerHTML = `
                <div class="character-list__grid">
                    ${charactersWithPortraits.map(character => `
                        <div class="character-card">
                            <div class="character-card__portrait">
                                ${character.portraitUrl 
                                    ? `<img 
                                        src="${character.portraitUrl}" 
                                        alt="${character.name} portrait"
                                        class="character-card__image"
                                    />`
                                    : `<div class="character-card__placeholder">
                                        <svg class="character-card__placeholder-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    </div>`
                                }
                            </div>
                            <h3 class="character-card__name">${character.name}</h3>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            console.error('Error loading characters:', error);
            contentContainer.innerHTML = `
                <div class="character-list__empty">
                    <svg class="character-list__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <p class="character-list__text">Ошибка загрузки персонажей</p>
                </div>
            `;
        }
    };

    // Check initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
        updateUI(session?.user);
    });

    // Listen for auth changes
    supabase.auth.onAuthStateChange((_event, session) => {
        updateUI(session?.user);
    });
</script> 