---
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";
import RollableDice from "./RollableDice.astro";

interface Props {
    beast: CollectionEntry<'bestiary'>;
}

const { beast } = Astro.props;
const { data } = beast;

// Get type title
const typeEntry = await getEntry(data.type);
const typeTitle = typeEntry.data.title;

// Get speeds
const speedsData = await Promise.all(
    data.speeds.map(async (speed) => {
        const entry = await getEntry(speed.type);
        return `${speed.value} метра ${entry.data.title}`;
    })
);
const joinedSpeeds = speedsData.join("; ");

// Get resistances
const resistancesData = data.resistances
    ? await Promise.all(
          data.resistances.map(async (resistance) => {
              const entry = await getEntry(resistance);
              return entry.data.title;
          })
      )
    : null;
const joinedResistances = resistancesData?.join(", ");

// Get immunities
const immunitiesData = data.immunities
    ? await Promise.all(
          data.immunities.map(async (immunity) => {
              const entry = await getEntry(immunity);
              return entry.data.title;
          })
      )
    : null;
const joinedImmunities = immunitiesData?.join(", ");

// Get vulnerabilities
const vulnerabilitiesData = data.vulnerabilities
    ? await Promise.all(
          data.vulnerabilities.map(async (vulnerability) => {
              const entry = await getEntry(vulnerability);
              return entry.data.title;
          })
      )
    : null;
const joinedVulnerabilities = vulnerabilitiesData?.join(", ");
---

<div class="beast-card">
    <div class="beast-card__header">
        <h1 class="beast-card__title">{data.title}</h1>
        <p class="beast-card__type">{typeTitle}</p>
    </div>
    
    <div class="beast-card__stats">
        <div class="beast-card__stat">
            <span class="beast-card__stat-label">Порог защиты</span>
            <span class="beast-card__stat-value">{data.armorClass}</span>
        </div>
        <div class="beast-card__stat">
            <span class="beast-card__stat-label">Здоровье</span>
            <span class="beast-card__stat-value">
                <RollableDice formula={data.health} />
            </span>
        </div>
        <div class="beast-card__stat">
            <span class="beast-card__stat-label">Скорость</span>
            <span class="beast-card__stat-value">{joinedSpeeds}</span>
        </div>
    </div>

    {(joinedResistances || joinedImmunities || joinedVulnerabilities) && (
        <div class="beast-card__defenses">
            {joinedResistances && (
                <div class="beast-card__defense">
                    <span class="beast-card__defense-label">Сопротивления:</span>
                    <span class="beast-card__defense-value">{joinedResistances}</span>
                </div>
            )}
            {joinedImmunities && (
                <div class="beast-card__defense">
                    <span class="beast-card__defense-label">Иммунитеты:</span>
                    <span class="beast-card__defense-value">{joinedImmunities}</span>
                </div>
            )}
            {joinedVulnerabilities && (
                <div class="beast-card__defense">
                    <span class="beast-card__defense-label">Уязвимости:</span>
                    <span class="beast-card__defense-value">{joinedVulnerabilities}</span>
                </div>
            )}
        </div>
    )}
</div>
